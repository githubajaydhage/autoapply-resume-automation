name: Job Application System (Enhanced)

# =================================================================
# ENHANCED PRODUCTION SYSTEM - Maximum Interview Generation
# =================================================================
# Features:
# ‚úÖ Multiple job sources (RemoteOK API, Naukri, career pages, RSS)
# ‚úÖ Curated HR email database (100+ verified company emails)
# ‚úÖ Email verification before sending (deliverability scoring)
# ‚úÖ Smart multi-stage follow-ups (Day 3, 7, 14)
# ‚úÖ Bounce detection and email quality tracking
# ‚úÖ Resume keyword optimization and match scoring
# ‚úÖ Auto-generated cover letters
# ‚úÖ Duplicate prevention and tracking
# ‚úÖ Resume attachment
# =================================================================
# ONLY 1 SECRET NEEDED: SENDER_PASSWORD (Gmail App Password)
# =================================================================

on:
  workflow_dispatch:
    inputs:
      job_location:
        description: 'Job Location'
        required: true
        default: 'Bangalore'
        type: choice
        options:
        - Bangalore
        - Mumbai
        - Delhi
        - Hyderabad
        - Pune
        - Chennai
        - Remote
        - India
      max_emails:
        description: 'Max new emails to send'
        required: true
        default: '15'
        type: choice
        options:
        - '5'
        - '10'
        - '15'
        - '20'
        - '30'
        - '50'
      send_followups:
        description: 'Send follow-up emails?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      scrape_only:
        description: 'Only scrape (no emails)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
        
  schedule:
    # Runs 3 times per day on weekdays (IST: 9:30 AM, 2:30 PM, 7:30 PM)
    - cron: '0 4,9,14 * * 1-5'

jobs:
  apply:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore Previous Data
      uses: actions/cache@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
        key: job-data-${{ runner.os }}-v3
        restore-keys: |
          job-data-${{ runner.os }}-

    # PHASE 1: Scrape Jobs
    - name: Phase 1 - Scrape Jobs (Multiple Sources)
      run: |
        echo "üîç PHASE 1: SCRAPING JOBS FROM RELIABLE SOURCES"
        echo "   Sources: RemoteOK API, Company Career Pages, Job Aggregators"
        python scripts/reliable_job_scraper.py
        echo ""
        echo "üáÆüá≥ Scraping Naukri.com..."
        python scripts/naukri_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        JOB_LOCATION: ${{ github.event.inputs.job_location || 'Bangalore' }}
        NAUKRI_LOCATION: ${{ github.event.inputs.job_location || 'bangalore' }}
        NAUKRI_KEYWORDS: 'python developer, software engineer, data scientist'
        NAUKRI_EXPERIENCE: 'mid'

    # PHASE 1.5: Resume Optimization & Job Matching
    - name: Phase 1.5 - Resume Optimization
      run: |
        echo "üìÑ PHASE 1.5: ANALYZING RESUME MATCH SCORES"
        python scripts/resume_optimizer.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 2: Load HR Emails
    - name: Phase 2 - Load HR Email Database
      run: |
        echo "üìß PHASE 2: LOADING HR EMAIL DATABASE"
        echo "   100+ verified company HR/recruitment emails"
        python scripts/curated_hr_database.py
        echo ""
        echo "   Finding HR emails from companies with active openings..."
        python scripts/hr_email_finder.py
        echo ""
        echo "   Also scraping additional emails from job postings..."
        python scripts/email_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 3: Generate Cover Letters & Send Application Emails
    - name: Phase 3 - Generate Cover Letters
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üìù PHASE 3A: GENERATING COVER LETTERS"
        python scripts/cover_letter_generator.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        YEARS_EXPERIENCE: '3+'
        APPLICANT_ROLE: 'Software Engineer'

    - name: Phase 3 - Send Application Emails
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì§ PHASE 3B: SENDING APPLICATION EMAILS"
        echo "   Max emails: ${{ github.event.inputs.max_emails || '15' }}"
        echo "   Using email verification for quality control..."
        python scripts/email_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_EMAILS: ${{ github.event.inputs.max_emails || '15' }}

    # PHASE 4: Send Smart Follow-Up Emails
    - name: Phase 4 - Send Multi-Stage Follow-Ups
      if: ${{ github.event.inputs.scrape_only != 'true' && github.event.inputs.send_followups != 'false' }}
      run: |
        echo "üîÑ PHASE 4: SMART MULTI-STAGE FOLLOW-UPS"
        echo "   Stage 1: Day 3 - Gentle Reminder"
        echo "   Stage 2: Day 7 - Value-Add Message"
        echo "   Stage 3: Day 14 - Final Follow-up"
        python scripts/followup_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_FOLLOWUPS: '15'

    # PHASE 5: Check for Bounces and Update Email Quality
    - name: Phase 5 - Check Email Bounces
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì¨ PHASE 5: CHECKING FOR BOUNCED EMAILS"
        python scripts/bounce_checker.py || true
        echo ""
        echo "üìß Updating verified emails database..."
        python scripts/verified_emails_db.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}

    - name: Save Data Cache
      uses: actions/cache/save@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/known_bad_emails.csv
          data/email_verification_log.csv
          data/naukri_jobs.csv
          data/resume_match_report.csv
          cover_letters/*.txt
        key: job-data-${{ runner.os }}-v4-${{ github.run_number }}

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: application-results-${{ github.run_number }}
        path: |
          data/jobs_today.csv
          data/all_hr_emails.csv
          data/curated_hr_emails.csv
          data/sent_emails_log.csv
          data/followup_log.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/problematic_emails.csv
          data/email_verification_log.csv
          data/naukri_jobs.csv
          data/resume_match_report.csv
          data/*.json
          cover_letters/*.txt
        retention-days: 30
      if: always()

    - name: Summary Report
      run: |
        echo ""
        echo "üìä =============================================="
        echo "üìä ENHANCED JOB APPLICATION SUMMARY"
        echo "üìä =============================================="
        if [ -f data/jobs_today.csv ]; then
          JOBS=$(wc -l < data/jobs_today.csv)
          echo "üîç Jobs Scraped: $((JOBS - 1))"
        fi
        if [ -f data/naukri_jobs.csv ]; then
          NAUKRI=$(wc -l < data/naukri_jobs.csv)
          echo "üáÆüá≥ Naukri Jobs: $((NAUKRI - 1))"
        fi
        if [ -f data/all_hr_emails.csv ]; then
          EMAILS=$(wc -l < data/all_hr_emails.csv)
          echo "üìß HR Emails Available: $((EMAILS - 1))"
        fi
        if [ -f data/sent_emails_log.csv ]; then
          SENT=$(wc -l < data/sent_emails_log.csv)
          echo "‚úâÔ∏è  Total Emails Sent: $((SENT - 1))"
        fi
        if [ -f data/followup_log.csv ]; then
          FOLLOWUPS=$(wc -l < data/followup_log.csv)
          echo "üîÑ Follow-ups Sent: $((FOLLOWUPS - 1))"
        fi
        if [ -f data/bounced_emails.csv ]; then
          BOUNCED=$(wc -l < data/bounced_emails.csv)
          echo "‚ùå Bounced Emails: $((BOUNCED - 1))"
        fi
        if [ -f data/verified_hr_emails.csv ]; then
          VERIFIED=$(wc -l < data/verified_hr_emails.csv)
          echo "‚úÖ Verified HR Emails: $((VERIFIED - 1))"
        fi
        if [ -d cover_letters ]; then
          COVERS=$(ls cover_letters/*.txt 2>/dev/null | wc -l)
          echo "üìù Cover Letters Generated: $COVERS"
        fi
        echo "üìä =============================================="
        echo "üí° TIP: Check artifacts for detailed reports"
        echo "üìä =============================================="
