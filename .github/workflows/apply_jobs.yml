name: Job Application System (Ultimate v5)

# =================================================================
# ULTIMATE PRODUCTION SYSTEM v6 - Maximum Interview Generation
# =================================================================
# NEW FEATURES in v6 (High Impact):
# ‚úÖ Email Open Tracking (know when HR reads your email)
# ‚úÖ WhatsApp/Telegram Alerts (instant mobile notifications)
# ‚úÖ Auto-Retry Failed Emails (verify & retry with alternates)
# =================================================================
# v5 Features:
# ‚úÖ ATS Keyword Optimizer (70%+ match filter)
# ‚úÖ Salary Intelligence System (market rate insights)
# ‚úÖ Job Priority Engine (urgent jobs first)
# ‚úÖ LinkedIn Warm-Up Plans (3x higher response)
# ‚úÖ Multi-Channel Analytics Dashboard
# ‚úÖ Slack Integration (instant interview alerts!)
# =================================================================
# v4 Features:
# ‚úÖ Skills Match Filter (70%+ threshold)
# ‚úÖ Interview Prep Generator (company research docs)
# ‚úÖ Thank You Email Automation
# ‚úÖ Weekly Summary Digest
# ‚úÖ Portfolio/GitHub links in emails
# =================================================================
# v3 Features:
# ‚úÖ Email Optimizer (personalized company openers, A/B subject testing)
# ‚úÖ Recruiter Name Finder ("Dear Priya" vs "Dear Hiring Manager")
# ‚úÖ Referral Request System (10x higher response rate!)
# ‚úÖ Optimal Send Timing (Tue-Thu, 9-11 AM IST)
# ‚úÖ Company-specific highlights in emails
# =================================================================
# v2 Features:
# ‚úÖ Smart Job-to-HR matching (only email when job found at company)
# ‚úÖ Reply detection (monitors inbox for HR responses)
# ‚úÖ Application status tracking (applied ‚Üí interview ‚Üí offer)
# ‚úÖ Enhanced job sources (Wellfound, Instahyre, Cutshort, etc.)
# ‚úÖ Job-specific email templates (not generic anymore)
# ‚úÖ Priority-based application queue
# =================================================================
# v1 Features:
# ‚úÖ Multiple job sources (RemoteOK API, Naukri, career pages, RSS)
# ‚úÖ Curated HR email database (100+ verified company emails)
# ‚úÖ Email verification before sending (deliverability scoring)
# ‚úÖ Smart multi-stage follow-ups (Day 3, 7, 14)
# ‚úÖ Bounce detection and email quality tracking
# ‚úÖ Resume keyword optimization and match scoring
# ‚úÖ Auto-generated cover letters
# ‚úÖ Duplicate prevention and tracking
# ‚úÖ Resume attachment
# =================================================================
# ONLY 1 SECRET NEEDED: SENDER_PASSWORD (Gmail App Password)
# =================================================================

on:
  workflow_dispatch:
    inputs:
      job_location:
        description: 'Job Location'
        required: true
        default: 'Bangalore'
        type: choice
        options:
        - Bangalore
        - Mumbai
        - Delhi
        - Hyderabad
        - Pune
        - Chennai
        - Remote
        - India
      max_emails:
        description: 'Max new emails to send'
        required: true
        default: '15'
        type: choice
        options:
        - '5'
        - '10'
        - '15'
        - '20'
        - '30'
        - '50'
      send_followups:
        description: 'Send follow-up emails?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      scrape_only:
        description: 'Only scrape (no emails)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      include_portfolio_links:
        description: 'Include GitHub/Portfolio links in emails?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      send_slack_notifications:
        description: 'Send Slack notifications?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      enable_mobile_alerts:
        description: 'WhatsApp/Telegram alerts?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_whatsapp:
        description: 'Enable WhatsApp (requires WHATSAPP_PHONE, CALLMEBOT_API_KEY secrets)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_telegram:
        description: 'Enable Telegram (requires TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID secrets)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_open_tracking:
        description: 'Track email opens?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      enable_auto_retry:
        description: 'Auto-retry failed emails?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
        
  schedule:
    # Runs 3 times per day on weekdays (IST: 9:30 AM, 2:30 PM, 7:30 PM)
    - cron: '0 4,9,14 * * 1-5'

jobs:
  apply:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore Previous Data
      uses: actions/cache@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
        key: job-data-${{ runner.os }}-v3
        restore-keys: |
          job-data-${{ runner.os }}-

    # PHASE 1: Scrape Jobs
    - name: Phase 1 - Scrape Jobs (Multiple Sources)
      run: |
        echo "üîç PHASE 1: SCRAPING JOBS FROM ALL SOURCES"
        echo "   Sources: RemoteOK, Arbeitnow, Himalayas, Jobicy, Adzuna"
        python scripts/reliable_job_scraper.py
        echo ""
        echo "üáÆüá≥ Scraping Naukri.com..."
        python scripts/naukri_scraper.py || true
        echo ""
        echo "üöÄ Scraping Enhanced Sources (Wellfound, LinkedIn, etc.)..."
        python scripts/enhanced_job_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        JOB_LOCATION: ${{ github.event.inputs.job_location || 'Bangalore' }}
        NAUKRI_LOCATION: ${{ github.event.inputs.job_location || 'bangalore' }}
        NAUKRI_KEYWORDS: 'python developer, software engineer, data scientist'
        NAUKRI_EXPERIENCE: 'mid'

    # PHASE 1.5: Resume Optimization & Job Matching
    - name: Phase 1.5 - Resume Optimization
      run: |
        echo "üìÑ PHASE 1.5: ANALYZING RESUME MATCH SCORES"
        python scripts/resume_optimizer.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 2: Load HR Emails
    - name: Phase 2 - Load HR Email Database
      run: |
        echo "üìß PHASE 2: LOADING HR EMAIL DATABASE"
        echo "   100+ verified company HR/recruitment emails"
        python scripts/curated_hr_database.py
        echo ""
        echo "   Finding HR emails from companies with active openings..."
        python scripts/hr_email_finder.py
        echo ""
        echo "   Also scraping additional emails from job postings..."
        python scripts/email_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 3: Generate Cover Letters & Send Application Emails
    - name: Phase 3 - Generate Cover Letters
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üìù PHASE 3A: GENERATING COVER LETTERS"
        python scripts/cover_letter_generator.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        YEARS_EXPERIENCE: '3+'
        APPLICANT_ROLE: 'Software Engineer'

    - name: Phase 3 - Send Application Emails
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì§ PHASE 3B: SENDING APPLICATION EMAILS (Optimized Mode)"
        echo "   Max emails: ${{ github.event.inputs.max_emails || '15' }}"
        echo "   Using smart job-to-HR matching..."
        echo "   Using email optimizer (personalized openers, A/B subjects)..."
        echo "   Using email verification for quality control..."
        echo "   Portfolio links: ${{ github.event.inputs.include_portfolio_links || 'false' }}"
        python scripts/email_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_EMAILS: ${{ github.event.inputs.max_emails || '15' }}
        INCLUDE_PORTFOLIO_LINKS: ${{ github.event.inputs.include_portfolio_links || 'false' }}

    # PHASE 3.5: Send Referral Requests (HIGH IMPACT - 10x response rate)
    - name: Phase 3.5 - Send Referral Requests
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "ü§ù PHASE 3.5A: SENDING REFERRAL REQUESTS"
        echo "   Referrals have 10x higher response rate than cold emails!"
        python scripts/referral_system.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RESUME_PATH: resumes/Shweta_Biradar_Resume.pdf
        MAX_REFERRAL_REQUESTS: '5'
        MAX_REFERRALS_PER_COMPANY: '2'

    # PHASE 3.6: Check for HR Replies
    - name: Phase 3.6 - Detect HR Replies
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì¨ PHASE 3.6: SCANNING INBOX FOR HR REPLIES"
        echo "   Looking for interview requests, offers, responses..."
        python scripts/reply_detector.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}

    # PHASE 4: Send Smart Follow-Up Emails
    - name: Phase 4 - Send Multi-Stage Follow-Ups
      if: ${{ github.event.inputs.scrape_only != 'true' && github.event.inputs.send_followups != 'false' }}
      run: |
        echo "üîÑ PHASE 4: SMART MULTI-STAGE FOLLOW-UPS"
        echo "   Stage 1: Day 3 - Gentle Reminder"
        echo "   Stage 2: Day 7 - Value-Add Message"
        echo "   Stage 3: Day 14 - Final Follow-up"
        python scripts/followup_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_FOLLOWUPS: '15'

    # PHASE 5: Check for Bounces and Update Email Quality
    - name: Phase 5 - Check Email Bounces
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì¨ PHASE 5: CHECKING FOR BOUNCED EMAILS"
        python scripts/bounce_checker.py || true
        echo ""
        echo "üìß Updating verified emails database..."
        python scripts/verified_emails_db.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}

    # PHASE 6: Update Application Tracker
    - name: Phase 6 - Update Application Tracker
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üìä PHASE 6: SYNCING APPLICATION STATUS TRACKER"
        echo "   Tracking: Applied ‚Üí Acknowledged ‚Üí Interview ‚Üí Offer"
        python scripts/application_tracker.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 7: Interview Success Suite
    - name: Phase 7 - Interview Prep & Weekly Summary
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üéØ PHASE 7: INTERVIEW SUCCESS SUITE"
        echo "   Generating interview prep docs for detected interviews..."
        echo "   Creating weekly activity summary..."
        python scripts/interview_success_suite.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 8-10: Analysis Phases (Priority, LinkedIn, Analytics)
    - name: Phase 8-10 - Run Analysis Phases
      run: |
        echo "üìä PHASES 8-10: ANALYSIS & INSIGHTS"
        echo "   Phase 8: Job Priority Analysis"
        echo "   Phase 9: LinkedIn Warm-Up Plans"
        echo "   Phase 10: Multi-Channel Analytics"
        python scripts/run_analysis_phases.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Save Data Cache
      uses: actions/cache/save@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/known_bad_emails.csv
          data/email_verification_log.csv
          data/naukri_jobs.csv
          data/resume_match_report.csv
          data/application_tracker.csv
          data/hr_replies.csv
          data/interview_requests.csv
          data/enhanced_jobs.csv
          data/subject_line_stats.csv
          data/company_insights_cache.json
          data/referral_requests_log.csv
          data/thank_you_log.csv
          data/weekly_summary_*.txt
          data/prioritized_jobs.csv
          data/linkedin_search_targets.txt
          data/linkedin_warmup_plans.txt
          data/analytics_dashboard.txt
          data/multi_channel_tracker.csv
          data/ats_report.txt
          data/email_opens_log.csv
          data/retry_log.csv
          data/email_verification_cache.json
          cover_letters/*.txt
          interview_prep/*.txt
        key: job-data-${{ runner.os }}-v8-${{ github.run_number }}

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: application-results-${{ github.run_number }}
        path: |
          data/jobs_today.csv
          data/all_hr_emails.csv
          data/curated_hr_emails.csv
          data/sent_emails_log.csv
          data/followup_log.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/problematic_emails.csv
          data/email_verification_log.csv
          data/naukri_jobs.csv
          data/resume_match_report.csv
          data/application_tracker.csv
          data/hr_replies.csv
          data/interview_requests.csv
          data/enhanced_jobs.csv
          data/subject_line_stats.csv
          data/thank_you_log.csv
          data/weekly_summary_*.txt
          data/prioritized_jobs.csv
          data/linkedin_search_targets.txt
          data/linkedin_warmup_plans.txt
          data/analytics_dashboard.txt
          data/multi_channel_tracker.csv
          data/ats_report.txt
          data/email_opens_log.csv
          data/open_tracking_report.txt
          data/retry_log.csv
          data/email_verification_cache.json
          data/*.json
          cover_letters/*.txt
          interview_prep/*.txt
        retention-days: 30
      if: always()

    # PHASE 11: Slack Notifications
    - name: Phase 11 - Send Slack Notifications
      if: ${{ github.event.inputs.send_slack_notifications != 'false' }}
      run: |
        echo "üì¢ PHASE 11: SENDING SLACK NOTIFICATIONS"
        echo "   Alerting for interviews, HR replies, and daily summary..."
        python scripts/slack_notifier.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    # PHASE 12: Auto-Retry Failed Emails (verify first, then retry)
    - name: Phase 12 - Auto-Retry Failed Emails
      if: ${{ github.event.inputs.scrape_only != 'true' && github.event.inputs.enable_auto_retry != 'false' }}
      run: |
        echo "üîÑ PHASE 12: AUTO-RETRY FAILED EMAILS"
        echo "   Finding failed/bounced emails..."
        echo "   Verifying alternate addresses before retry..."
        echo "   Only retrying with genuine, validated emails..."
        python scripts/auto_retry_emails.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}

    # PHASE 13: Email Open Tracking Report
    - name: Phase 13 - Email Open Tracking
      if: ${{ github.event.inputs.enable_open_tracking == 'true' }}
      run: |
        echo "üìä PHASE 13: EMAIL OPEN TRACKING"
        echo "   Generating open tracking report..."
        python scripts/email_open_tracker.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        ENABLE_OPEN_TRACKING: ${{ github.event.inputs.enable_open_tracking }}
        TRACKING_PIXEL_URL: ${{ secrets.TRACKING_PIXEL_URL }}

    # PHASE 14: Mobile Alerts (WhatsApp/Telegram)
    - name: Phase 14 - Mobile Alerts
      if: ${{ github.event.inputs.enable_mobile_alerts == 'true' }}
      run: |
        echo "üì± PHASE 14: MOBILE ALERTS (WhatsApp/Telegram)"
        echo "   Sending instant notifications to your phone..."
        python scripts/mobile_alerts.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        ENABLE_WHATSAPP: ${{ github.event.inputs.enable_whatsapp }}
        WHATSAPP_PHONE: ${{ secrets.WHATSAPP_PHONE }}
        CALLMEBOT_API_KEY: ${{ secrets.CALLMEBOT_API_KEY }}
        ENABLE_TELEGRAM: ${{ github.event.inputs.enable_telegram }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    - name: Summary Report
      run: |
        echo ""
        echo "üìä =============================================="
        echo "üìä JOB APPLICATION SUMMARY v6 - ULTIMATE EDITION"
        echo "üìä =============================================="
        if [ -f data/jobs_today.csv ]; then
          JOBS=$(wc -l < data/jobs_today.csv)
          echo "üîç Jobs Scraped: $((JOBS - 1))"
        fi
        if [ -f data/prioritized_jobs.csv ]; then
          PRIORITY=$(grep -c "üî¥ URGENT\|üü† HIGH" data/prioritized_jobs.csv 2>/dev/null || echo "0")
          echo "‚ö° High Priority Jobs: $PRIORITY"
        fi
        if [ -f data/enhanced_jobs.csv ]; then
          ENHANCED=$(wc -l < data/enhanced_jobs.csv)
          echo "üöÄ Enhanced Sources Jobs: $((ENHANCED - 1))"
        fi
        if [ -f data/naukri_jobs.csv ]; then
          NAUKRI=$(wc -l < data/naukri_jobs.csv)
          echo "üáÆüá≥ Naukri Jobs: $((NAUKRI - 1))"
        fi
        if [ -f data/all_hr_emails.csv ]; then
          EMAILS=$(wc -l < data/all_hr_emails.csv)
          echo "üìß HR Emails Available: $((EMAILS - 1))"
        fi
        if [ -f data/sent_emails_log.csv ]; then
          SENT=$(wc -l < data/sent_emails_log.csv)
          echo "‚úâÔ∏è  Total Emails Sent: $((SENT - 1))"
        fi
        if [ -f data/referral_requests_log.csv ]; then
          REFERRALS=$(wc -l < data/referral_requests_log.csv)
          echo "ü§ù Referral Requests: $((REFERRALS - 1))"
        fi
        if [ -f data/followup_log.csv ]; then
          FOLLOWUPS=$(wc -l < data/followup_log.csv)
          echo "üîÑ Follow-ups Sent: $((FOLLOWUPS - 1))"
        fi
        if [ -f data/bounced_emails.csv ]; then
          BOUNCED=$(wc -l < data/bounced_emails.csv)
          echo "‚ùå Bounced Emails: $((BOUNCED - 1))"
        fi
        if [ -f data/verified_hr_emails.csv ]; then
          VERIFIED=$(wc -l < data/verified_hr_emails.csv)
          echo "‚úÖ Verified HR Emails: $((VERIFIED - 1))"
        fi
        if [ -f data/hr_replies.csv ]; then
          REPLIES=$(wc -l < data/hr_replies.csv)
          echo "üì¨ HR Replies Detected: $((REPLIES - 1))"
        fi
        if [ -f data/interview_requests.csv ]; then
          INTERVIEWS=$(wc -l < data/interview_requests.csv)
          echo "üéØ Interview Requests: $((INTERVIEWS - 1))"
        fi
        if [ -f data/application_tracker.csv ]; then
          TRACKED=$(wc -l < data/application_tracker.csv)
          echo "üìä Applications Tracked: $((TRACKED - 1))"
        fi
        if [ -f data/subject_line_stats.csv ]; then
          echo "üìà A/B Subject Testing: Active"
        fi
        if [ -f data/linkedin_warmup_plans.txt ]; then
          echo "üîó LinkedIn Warm-Up Plans: Generated"
        fi
        if [ -f data/analytics_dashboard.txt ]; then
          echo "üìä Analytics Dashboard: Generated"
        fi
        if [ -f data/retry_log.csv ]; then
          RETRIED=$(wc -l < data/retry_log.csv)
          echo "üîÑ Emails Auto-Retried: $((RETRIED - 1))"
        fi
        if [ -f data/email_opens_log.csv ]; then
          OPENS=$(grep -c "open_count.*[1-9]" data/email_opens_log.csv 2>/dev/null || echo "0")
          echo "üëÄ Emails Opened: $OPENS"
        fi
        if [ -d cover_letters ]; then
          COVERS=$(ls cover_letters/*.txt 2>/dev/null | wc -l)
          echo "üìù Cover Letters Generated: $COVERS"
        fi
        echo "üìä =============================================="
        echo "üí° TIP: Download artifacts for full reports!"
        echo "üìä =============================================="
