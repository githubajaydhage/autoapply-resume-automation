name: Job Application System (Production Ready)

# =================================================================
# PRODUCTION READY - Maximum Application Outreach System
# =================================================================
# Features:
# ‚úÖ Multiple reliable job sources (RemoteOK API, career pages, RSS)
# ‚úÖ Curated HR email database (100+ verified company emails)
# ‚úÖ Personalized cold email outreach
# ‚úÖ Automatic follow-up emails (5 days after initial contact)
# ‚úÖ Duplicate prevention and tracking
# ‚úÖ Resume attachment
# =================================================================
# ONLY 1 SECRET NEEDED: SENDER_PASSWORD (Gmail App Password)
# =================================================================

on:
  workflow_dispatch:
    inputs:
      job_location:
        description: 'Job Location'
        required: true
        default: 'Bangalore'
        type: choice
        options:
        - Bangalore
        - Mumbai
        - Delhi
        - Hyderabad
        - Pune
        - Chennai
        - Remote
        - India
      max_emails:
        description: 'Max new emails to send'
        required: true
        default: '15'
        type: choice
        options:
        - '5'
        - '10'
        - '15'
        - '20'
        - '30'
        - '50'
      send_followups:
        description: 'Send follow-up emails?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      scrape_only:
        description: 'Only scrape (no emails)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
        
  schedule:
    # Runs at 9 AM UTC weekdays (2:30 PM IST)
    - cron: '0 9 * * 1-5'

jobs:
  apply:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore Previous Data
      uses: actions/cache@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
        key: job-data-${{ runner.os }}-v3
        restore-keys: |
          job-data-${{ runner.os }}-

    # PHASE 1: Scrape Jobs
    - name: Phase 1 - Scrape Jobs (Multiple Sources)
      run: |
        echo "üîç PHASE 1: SCRAPING JOBS FROM RELIABLE SOURCES"
        echo "   Sources: RemoteOK API, Company Career Pages, Job Aggregators"
        python scripts/reliable_job_scraper.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        JOB_LOCATION: ${{ github.event.inputs.job_location || 'Bangalore' }}

    # PHASE 2: Load HR Emails
    - name: Phase 2 - Load HR Email Database
      run: |
        echo "üìß PHASE 2: LOADING HR EMAIL DATABASE"
        echo "   100+ verified company HR/recruitment emails"
        python scripts/curated_hr_database.py
        echo ""
        echo "   Finding HR emails from companies with active openings..."
        python scripts/hr_email_finder.py
        echo ""
        echo "   Also scraping additional emails from job postings..."
        python scripts/email_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    # PHASE 3: Send Application Emails
    - name: Phase 3 - Send Application Emails
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üì§ PHASE 3: SENDING APPLICATION EMAILS"
        echo "   Max emails: ${{ github.event.inputs.max_emails || '15' }}"
        python scripts/email_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_EMAILS: ${{ github.event.inputs.max_emails || '15' }}

    # PHASE 4: Send Follow-Up Emails
    - name: Phase 4 - Send Follow-Up Emails
      if: ${{ github.event.inputs.scrape_only != 'true' && github.event.inputs.send_followups != 'false' }}
      run: |
        echo "üîÑ PHASE 4: SENDING FOLLOW-UP EMAILS"
        python scripts/followup_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        MAX_FOLLOWUPS: '10'

    - name: Save Data Cache
      uses: actions/cache/save@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/jobs_today.csv
          data/curated_hr_emails.csv
        key: job-data-${{ runner.os }}-v3-${{ github.run_number }}

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: application-results-${{ github.run_number }}
        path: |
          data/jobs_today.csv
          data/all_hr_emails.csv
          data/curated_hr_emails.csv
          data/sent_emails_log.csv
          data/followup_log.csv
          data/*.json
        retention-days: 30
      if: always()

    - name: Summary Report
      run: |
        echo ""
        echo "üìä =============================================="
        echo "üìä JOB APPLICATION SUMMARY REPORT"
        echo "üìä =============================================="
        if [ -f data/jobs_today.csv ]; then
          JOBS=$(wc -l < data/jobs_today.csv)
          echo "üîç Jobs Scraped: $((JOBS - 1))"
        fi
        if [ -f data/all_hr_emails.csv ]; then
          EMAILS=$(wc -l < data/all_hr_emails.csv)
          echo "üìß HR Emails Available: $((EMAILS - 1))"
        fi
        if [ -f data/sent_emails_log.csv ]; then
          SENT=$(wc -l < data/sent_emails_log.csv)
          echo "‚úâÔ∏è  Total Emails Sent: $((SENT - 1))"
        fi
        if [ -f data/followup_log.csv ]; then
          FOLLOWUPS=$(wc -l < data/followup_log.csv)
          echo "üîÑ Follow-ups Sent: $((FOLLOWUPS - 1))"
        fi
        echo "üìä =============================================="
