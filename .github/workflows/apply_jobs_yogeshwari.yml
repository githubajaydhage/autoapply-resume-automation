name: Job Application - Yogeshwari Mane (Interior Design)

# =================================================================
# YOGESHWARI MANE - AutoCAD Designer / Interior Designer
# Branch: v.1.2.0-geeta
# =================================================================
# üìÖ CRON SCHEDULE: Runs 3x daily (10:00 AM, 3:00 PM, 8:00 PM IST)
# ‚ö†Ô∏è  CRON ISSUE: Scheduled workflows ONLY run from DEFAULT branch
#    ‚úÖ Manual runs work from any branch (v.1.2.0-geeta ‚úì)
#    ‚ùå Scheduled runs only work from main/master branch
#    
#    üîß SOLUTION: Make v.1.2.0-geeta the default branch:
#    1. Go to GitHub repo ‚Üí Settings ‚Üí Branches
#    2. Change default branch from "main" to "v.1.2.0-geeta"
#    3. Cron will start working automatically
# =================================================================
# v7 FEATURES (Latest):
# ‚úÖ Multi-Job Workflow (each phase visible in UI, can cancel individually)
# ‚úÖ No Hardcoded Values (all config from JOB_KEYWORDS)
# ‚úÖ Industry-Prioritized HR Database (Interior Design first!)
# ‚úÖ Fast Referrals (5-15s delays, 10 max)
# ‚úÖ Dynamic Company Discovery (finds companies with active openings)
# ‚úÖ IT Company Filtering (excludes irrelevant IT companies)
# =================================================================
# SECRETS CONFIGURED ‚úÖ: SENDER_PASSWORD_YOGESHWARI (Gmail App Password)
# =================================================================

on:
  # Daily schedule - runs 3x daily (10:30 AM, 3:30 PM, 8:30 PM IST) - 30 min after Shweta
  schedule:
    - cron: '0 5 * * *'    # 10:30 AM IST
    - cron: '0 10 * * *'   # 3:30 PM IST
    - cron: '0 15 * * *'   # 8:30 PM IST
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      job_location:
        description: 'Job Location'
        required: true
        default: 'Bangalore'
        type: choice
        options:
        - Bangalore
        - Mumbai
        - Delhi
        - Hyderabad
        - Pune
        - Chennai
        - Remote
        - India
      max_emails:
        description: 'Max new emails to send'
        required: true
        default: '15'
        type: choice
        options:
        - '5'
        - '10'
        - '15'
        - '20'
        - '30'
        - '50'
      send_followups:
        description: 'Send follow-up emails?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      scrape_only:
        description: 'Only scrape (no emails)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      include_portfolio_links:
        description: 'Include Portfolio links?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      send_slack_notifications:
        description: 'Slack notifications?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      enable_mobile_alerts:
        description: 'WhatsApp/Telegram alerts?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_whatsapp:
        description: 'Enable WhatsApp (requires WHATSAPP_PHONE, CALLMEBOT_API_KEY secrets)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_telegram:
        description: 'Enable Telegram (requires TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID secrets)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
    
  # DISABLED: Push trigger to avoid running on every commit
  # push:
  #   branches:
  #     - v.1.2.0-geeta

# Cancel any in-progress workflow when a new one starts
concurrency:
  group: job-application-yogeshwari-${{ github.ref }}
  cancel-in-progress: true

# ============================================
# üéØ CENTRALIZED USER CONFIGURATION
# All scripts read from these environment variables
# ============================================
env:
  # User Identity
  APPLICANT_NAME: 'Yogeshwari Mane'
  APPLICANT_FIRST_NAME: 'Yogeshwari'
  APPLICANT_LAST_NAME: 'Mane'
  APPLICANT_EMAIL: 'maneyogeshwari09606@gmail.com'
  SENDER_EMAIL: 'maneyogeshwari09606@gmail.com'
  APPLICANT_PHONE: '+91-8147693539'
  APPLICANT_LOCATION: 'Bangalore, Karnataka, India'
  APPLICANT_CITY: 'Bangalore'
  APPLICANT_COUNTRY: 'India'
  APPLICANT_LINKEDIN: 'https://www.linkedin.com/in/yogeshwari-mane/'
  APPLICANT_EXPERIENCE: '3.5'
  YEARS_EXPERIENCE: '3.5'
  APPLICANT_TARGET_ROLE: 'AutoCAD Designer, Interior Designer, Estimation Engineer'
  APPLICANT_SKILLS: 'AutoCAD, SketchUp, 3Ds Max, Revit, Interior Design, Estimation, Quantity Surveying'
  
  # Resume Configuration
  RESUME_FILENAME: 'Yogeshwari_Mane_Resume.pdf'
  RESUME_PATH: 'resumes/Yogeshwari_Mane_Resume.pdf'
  
  # ‚ö†Ô∏è JOB KEYWORDS - MOST IMPORTANT! (Interior Design focused)
  JOB_KEYWORDS: 'autocad designer, interior designer, estimation engineer, quantity surveyor, billing engineer, drafting engineer, revit, civil draftsman, design coordinator'
  NAUKRI_KEYWORDS: 'autocad designer, interior designer, estimation engineer, quantity surveyor'
  
  # üö´ EXCLUDE IT COMPANIES - For Interior Design roles only!
  EXCLUDE_IT_COMPANIES: 'true'
  
  # Optional Settings
  SEND_TO_AGENCIES: 'true'
  MAX_REFERRAL_REQUESTS: '10'
  MAX_REFERRALS_PER_COMPANY: '1'

jobs:
  # ============================================
  # JOB 1: SETUP & SCRAPE JOBS
  # ============================================
  scrape-jobs:
    name: "üîç Phase 1: Scrape Jobs"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    outputs:
      jobs_count: ${{ steps.count.outputs.jobs }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore Previous Data
      uses: actions/cache@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/curated_hr_emails.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/referral_requests_log.csv
          data/discovered_hr_emails.csv
          data/discovered_employees.csv
          data/discovered_companies.csv
        key: job-data-yogeshwari-${{ runner.os }}-v10-${{ github.run_number }}
        restore-keys: |
          job-data-yogeshwari-${{ runner.os }}-v10-
          job-data-yogeshwari-${{ runner.os }}-v9-
          job-data-yogeshwari-${{ runner.os }}-

    - name: Scrape Jobs (RemoteOK, Arbeitnow, Jobicy, Adzuna)
      run: |
        echo "üîç Scraping jobs from multiple sources..."
        python scripts/reliable_job_scraper.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        JOB_LOCATION: ${{ github.event.inputs.job_location || 'Bangalore' }}

    - name: Scrape Naukri.com
      run: |
        echo "üáÆüá≥ Scraping Naukri.com..."
        python scripts/naukri_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        NAUKRI_LOCATION: ${{ github.event.inputs.job_location || 'bangalore' }}
        NAUKRI_EXPERIENCE: 'mid'

    - name: Scrape Enhanced Sources
      run: |
        echo "üöÄ Scraping Wellfound, LinkedIn, etc..."
        python scripts/enhanced_job_scraper.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Count Jobs
      id: count
      run: |
        if [ -f data/jobs_today.csv ]; then
          JOBS=$(($(wc -l < data/jobs_today.csv) - 1))
          echo "jobs=$JOBS" >> $GITHUB_OUTPUT
          echo "‚úÖ Found $JOBS jobs"
        else
          echo "jobs=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload Scraped Jobs
      uses: actions/upload-artifact@v4
      with:
        name: scraped-jobs
        path: |
          data/jobs_today.csv
          data/naukri_jobs.csv
          data/enhanced_jobs.csv
          data/sent_emails_log.csv
          data/followup_log.csv
        retention-days: 1

  # ============================================
  # JOB 2: DISCOVER HR EMAILS
  # ============================================
  discover-hr:
    name: "üìß Phase 2: Find HR Emails"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: scrape-jobs
    
    outputs:
      emails_count: ${{ steps.count.outputs.emails }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download Scraped Jobs
      uses: actions/download-artifact@v4
      with:
        name: scraped-jobs
        path: data/

    - name: Load Curated HR Database (Interior Design Prioritized!)
      run: |
        echo "üìö Loading HR emails (Interior Design companies FIRST!)..."
        python scripts/curated_hr_database.py
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Find HR Emails from Job Postings (FAST MODE)
      run: |
        echo "üîç Finding HR emails (fast mode - using cached data)..."
        python scripts/hr_email_finder.py
        python scripts/email_scraper.py || true
        echo "üìà Running Advanced HR Discovery (FAST - 5 companies max)..."
        python scripts/advanced_hr_discovery.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        MAX_DISCOVERY_COMPANIES: '5'  # Only discover 5 NEW companies per run
        FAST_DISCOVERY: 'true'  # Use fast 2-method discovery instead of 6-method

    - name: Resume Optimization Analysis
      run: |
        echo "üìÑ Analyzing resume match scores..."
        python scripts/resume_optimizer.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Count HR Emails
      id: count
      run: |
        if [ -f data/all_hr_emails.csv ]; then
          EMAILS=$(($(wc -l < data/all_hr_emails.csv) - 1))
          echo "emails=$EMAILS" >> $GITHUB_OUTPUT
          echo "‚úÖ Found $EMAILS HR emails"
        else
          echo "emails=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload HR Data
      uses: actions/upload-artifact@v4
      with:
        name: hr-emails
        path: |
          data/
        retention-days: 1

  # ============================================
  # JOB 3: SEND APPLICATION EMAILS
  # ============================================
  send-emails:
    name: "‚úâÔ∏è Phase 3: Send Emails"
    runs-on: ubuntu-latest
    needs: discover-hr
    if: ${{ github.event.inputs.scrape_only != 'true' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download HR Data
      uses: actions/download-artifact@v4
      with:
        name: hr-emails
        path: data/

    - name: Generate Cover Letters
      run: |
        echo "üìù Generating personalized cover letters..."
        python scripts/cover_letter_generator.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Send Application Emails
      run: |
        echo "üì§ Sending application emails (max: ${{ github.event.inputs.max_emails || '15' }})..."
        python scripts/email_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}
        MAX_EMAILS: ${{ github.event.inputs.max_emails || '15' }}
        INCLUDE_PORTFOLIO_LINKS: ${{ github.event.inputs.include_portfolio_links || 'false' }}

    - name: Upload Email Results
      uses: actions/upload-artifact@v4
      with:
        name: email-results
        path: |
          data/
          cover_letters/
        retention-days: 1

  # ============================================
  # JOB 4: SEND REFERRAL REQUESTS
  # ============================================
  send-referrals:
    name: "ü§ù Phase 4: Referrals"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: send-emails
    if: ${{ github.event.inputs.scrape_only != 'true' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download Email Results
      uses: actions/download-artifact@v4
      with:
        name: email-results
        path: data/

    - name: Send Referral Requests (10x response rate!)
      run: |
        echo "ü§ù Sending referral requests..."
        echo "   Max: $MAX_REFERRAL_REQUESTS referrals"
        python scripts/referral_system.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}

    - name: Detect HR Replies
      run: |
        echo "üì¨ Scanning inbox for HR replies..."
        python scripts/reply_detector.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}

    - name: Upload Referral Results
      uses: actions/upload-artifact@v4
      with:
        name: referral-results
        path: |
          data/
        retention-days: 1

  # ============================================
  # JOB 5: FOLLOW-UPS & BOUNCE CHECKING
  # ============================================
  followups:
    name: "üîÑ Phase 5: Follow-ups"
    runs-on: ubuntu-latest
    needs: send-referrals
    if: ${{ github.event.inputs.scrape_only != 'true' && github.event.inputs.send_followups != 'false' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download Referral Results
      uses: actions/download-artifact@v4
      with:
        name: referral-results
        path: data/

    - name: Send Multi-Stage Follow-Ups
      run: |
        echo "üîÑ Sending follow-ups (Day 3, 7, 14)..."
        python scripts/followup_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}
        MAX_FOLLOWUPS: '15'

    - name: Check Email Bounces
      run: |
        echo "üì¨ Checking for bounced emails..."
        python scripts/bounce_checker.py || true
        python scripts/verified_emails_db.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}

    - name: Auto-Retry Failed Emails
      run: |
        echo "üîÑ Retrying failed emails..."
        python scripts/auto_retry_emails.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD_YOGESHWARI }}

    - name: Upload Follow-up Results
      uses: actions/upload-artifact@v4
      with:
        name: followup-results
        path: |
          data/
        retention-days: 1

  # ============================================
  # JOB 6: ANALYTICS & NOTIFICATIONS
  # ============================================
  notifications:
    name: "üìä Phase 6: Analytics & Notify"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [scrape-jobs, discover-hr, send-emails, send-referrals, followups]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: v.1.2.0-geeta

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download All Results
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
      continue-on-error: true

    - name: Merge Data Files
      run: |
        mkdir -p data
        find artifacts -name "*.csv" -exec cp {} data/ \; 2>/dev/null || true
        find artifacts -name "*.json" -exec cp {} data/ \; 2>/dev/null || true
        find artifacts -name "*.txt" -exec cp {} data/ \; 2>/dev/null || true
      continue-on-error: true

    - name: Update Application Tracker
      run: |
        echo "üìä Updating application tracker..."
        python scripts/application_tracker.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Interview Prep & Weekly Summary
      run: |
        echo "üéØ Generating interview prep & summary..."
        python scripts/interview_success_suite.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run Analysis Phases
      run: |
        echo "üìä Running analytics..."
        python scripts/run_analysis_phases.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Send Slack Notifications
      if: ${{ github.event.inputs.send_slack_notifications != 'false' }}
      run: |
        echo "üí¨ Sending Slack notifications..."
        python scripts/slack_notifier.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Send Mobile Alerts
      if: ${{ github.event.inputs.enable_mobile_alerts == 'true' }}
      run: |
        echo "üì± Sending mobile alerts..."
        python scripts/mobile_alerts.py || true
      env:
        PYTHONPATH: ${{ github.workspace }}
        ENABLE_WHATSAPP: ${{ github.event.inputs.enable_whatsapp }}
        WHATSAPP_PHONE: ${{ secrets.WHATSAPP_PHONE_YOGESHWARI }}
        CALLMEBOT_API_KEY: ${{ secrets.CALLMEBOT_API_KEY_YOGESHWARI }}
        ENABLE_TELEGRAM: ${{ github.event.inputs.enable_telegram }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_YOGESHWARI }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID_YOGESHWARI }}

    - name: Save Data Cache
      uses: actions/cache/save@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/followup_log.csv
          data/all_hr_emails.csv
          data/curated_hr_emails.csv
          data/bounced_emails.csv
          data/verified_hr_emails.csv
          data/referral_requests_log.csv
          data/discovered_hr_emails.csv
          data/discovered_employees.csv
          data/discovered_companies.csv
        key: job-data-yogeshwari-${{ runner.os }}-v10-${{ github.run_number }}

    - name: üíæ Commit HR Database to Repo (Permanent Storage)
      run: |
        echo "üíæ Saving HR database permanently to repo..."
        git config user.name "Job Automation Bot"
        git config user.email "bot@github.com"
        
        # Count new emails
        NEW_EMAILS=0
        if [ -f data/discovered_hr_emails.csv ]; then
          NEW_EMAILS=$(($(wc -l < data/discovered_hr_emails.csv) - 1))
        fi
        
        # Add data files
        git add data/discovered_hr_emails.csv data/discovered_companies.csv data/discovered_employees.csv data/sent_emails_log.csv data/applied_log.csv 2>/dev/null || true
        
        # Commit if there are changes
        git diff --staged --quiet || git commit -m "ü§ñ Auto: HR Database updated (+$NEW_EMAILS emails) - $(date '+%Y-%m-%d %H:%M')"
        
        # Push changes
        git push || echo "‚ö†Ô∏è Push failed (may need PAT with write access)"
      continue-on-error: true

    - name: Upload Final Results
      uses: actions/upload-artifact@v4
      with:
        name: final-results-${{ github.run_number }}
        path: |
          data/
          cover_letters/
          interview_prep/
        retention-days: 30

    - name: Summary Report
      run: |
        echo ""
        echo "üìä =============================================="
        echo "üìä JOB APPLICATION SUMMARY v7"
        echo "üìä =============================================="
        echo "üîç Jobs Scraped: ${{ needs.scrape-jobs.outputs.jobs_count || 'N/A' }}"
        echo "üìß HR Emails Found: ${{ needs.discover-hr.outputs.emails_count || 'N/A' }}"
        if [ -f data/sent_emails_log.csv ]; then
          SENT=$(($(wc -l < data/sent_emails_log.csv) - 1))
          echo "‚úâÔ∏è  Emails Sent (Total): $SENT"
        fi
        if [ -f data/referral_requests_log.csv ]; then
          REF=$(($(wc -l < data/referral_requests_log.csv) - 1))
          echo "ü§ù Referrals Sent: $REF"
        fi
        if [ -f data/followup_log.csv ]; then
          FU=$(($(wc -l < data/followup_log.csv) - 1))
          echo "üîÑ Follow-ups Sent: $FU"
        fi
        if [ -f data/hr_replies.csv ]; then
          REPLIES=$(($(wc -l < data/hr_replies.csv) - 1))
          echo "üì¨ HR Replies: $REPLIES"
        fi
        if [ -f data/interview_requests.csv ]; then
          INT=$(($(wc -l < data/interview_requests.csv) - 1))
          echo "üéØ Interviews Detected: $INT"
        fi
        echo "üìä =============================================="
        echo "üí° Download 'final-results' artifact for full reports!"
        echo "üìä =============================================="
