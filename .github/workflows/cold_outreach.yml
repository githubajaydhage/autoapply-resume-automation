name: Cold Email Outreach System

# Email-based job application system
# Scrapes HR emails from job postings and company websites
# Sends personalized application emails with resume attached

on:
  workflow_dispatch:
    inputs:
      max_emails:
        description: 'Maximum emails to send per run'
        required: true
        default: '20'
        type: choice
        options:
        - '5'
        - '10'
        - '20'
        - '50'
      scrape_only:
        description: 'Only scrape emails (no sending)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
  schedule:
    - cron: '0 9 * * 1-5' # Runs at 9 AM UTC on weekdays (2:30 PM IST)

jobs:
  cold-outreach:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore Previous Data
      uses: actions/cache@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/all_hr_emails.csv
        key: cold-outreach-data-${{ runner.os }}-v1
        restore-keys: |
          cold-outreach-data-${{ runner.os }}-

    - name: Scrape HR Emails
      run: |
        echo "üîç PHASE 1: Scraping HR emails from job postings and company pages"
        python scripts/email_scraper.py
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Send Personalized Emails
      if: ${{ github.event.inputs.scrape_only != 'true' }}
      run: |
        echo "üìß PHASE 2: Sending personalized application emails"
        python scripts/email_sender.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        # Email sending configuration
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        SENDER_NAME: ${{ secrets.SENDER_NAME || 'Job Applicant' }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        # Applicant details
        APPLICANT_NAME: ${{ secrets.APPLICANT_NAME }}
        APPLICANT_PHONE: ${{ secrets.APPLICANT_PHONE }}
        APPLICANT_LINKEDIN: ${{ secrets.APPLICANT_LINKEDIN }}
        APPLICANT_EXPERIENCE: ${{ secrets.APPLICANT_EXPERIENCE || '3' }}
        APPLICANT_SKILLS: ${{ secrets.APPLICANT_SKILLS || 'Data Analysis, Python, SQL, Excel, Tableau' }}
        # Email limits
        MAX_EMAILS: ${{ github.event.inputs.max_emails || '20' }}

    - name: Save Data Cache
      uses: actions/cache/save@v3
      with:
        path: |
          data/sent_emails_log.csv
          data/all_hr_emails.csv
        key: cold-outreach-data-${{ runner.os }}-v1-${{ github.run_number }}

    - name: Upload Outreach Logs
      uses: actions/upload-artifact@v4
      with:
        name: cold-outreach-logs
        path: |
          data/all_hr_emails.csv
          data/hr_emails_from_jobs.csv
          data/hr_emails_from_companies.csv
          data/sent_emails_log.csv
          data/cold_outreach.log
          data/cold_outreach_report.json
      if: always()

    - name: Summary
      run: |
        echo "üìä COLD OUTREACH SUMMARY"
        echo "========================"
        if [ -f data/all_hr_emails.csv ]; then
          echo "HR Emails Found: $(wc -l < data/all_hr_emails.csv)"
        fi
        if [ -f data/sent_emails_log.csv ]; then
          echo "Emails Sent (Total): $(wc -l < data/sent_emails_log.csv)"
        fi
        echo "========================"
